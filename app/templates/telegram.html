{% extends "layouts/base.html" %}

{% block content %}
<style>
      #telegram-tool-pane .sticky-top {
            top: 0;
            z-index: 1020;
            background-color: var(--card-bg) !important;
            padding: 0.25rem 0;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 1rem;
      }

      #telegram-tool-pane .main-tool-container .tab-content,
      #telegram-tool-pane .main-tool-container .nav-pills {
            background: none;
            border: none;
            padding: 0;
      }

      #telegram-tool-pane .nav-pills .nav-link {
            color: var(--text-color);
      }

      #telegram-tool-pane .nav-pills .nav-link.active {
            background-color: var(--primary-color);
            color: #fff;
      }

      #tg-session-tables-container .table-responsive {
            max-height: 75vh;
            overflow-y: auto;
      }

      .stat-card {
            border: 1px solid #4b5563;
            padding: 0.75rem 1.25rem;
            min-width: 320px;
      }

      #telegram-tool-pane .main-tool-container {
            display: flex;
            align-items: flex-start;
            gap: 1.5rem;
      }

      #telegram-tool-pane .nav-pills {
            flex: 0 0 220px;
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            padding: 0.5rem !important;
            background-color: var(--card-bg) !important;
      }

      #telegram-tool-pane .nav-pills .nav-link {
            margin-bottom: 0.25rem;
            text-align: left;
      }

      #telegram-tool-pane .tab-content {
            flex: 1;
            min-width: 0;
      }

      #tg-group-task-cards .card {
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            border: 2px solid transparent;
      }

      #tg-group-task-cards .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
      }

      #tg-group-task-cards .card.card-selected {
            border-color: var(--primary-color);
            box-shadow: 0 0 15px rgba(0, 112, 243, 0.5);
      }

      .status-checking {
            color: #17a2b8;
            font-weight: 500;
      }

      .auto-seeding-time-input::-webkit-outer-spin-button,
      .auto-seeding-time-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
      }

      .auto-seeding-time-input[type=number] {
            -moz-appearance: textfield;
      }
</style>

<div class="tab-pane fade show active" id="telegram-tool-pane" role="tabpanel">
      <div class="sticky-top">
            <div class="d-flex flex-wrap justify-content-between align-items-center gap-3">
                  <div class="d-flex align-items-center gap-3 flex-wrap">
                        <div class="stat-card bg-dark rounded">
                              <div class="d-flex align-items-center">
                                    <h6 class="mb-0 me-4">All Bots: <span id="tg-total-sessions-count"
                                                class="text-warning fw-bold">0</span></h6>
                                    <h6 class="mb-0">üìä Status: <span id="tg-status-progress-text"
                                                class="text-info fw-bold">Idle</span></h6>
                              </div>
                              <hr class="my-1" style="border-top-color: #4b5563;">
                              <div class="text-center small">
                                    <span class="me-3 text-success">Success: <b
                                                id="tg-status-success-count">0</b></span>
                                    <span class="text-danger">Failed: <b
                                                id="tg-status-failed-count">0</b></span>
        </div>
    </div>
                        <div class="d-flex gap-2 align-items-end flex-wrap">
                              <div>
                                    <label for="tg-core-input"
                                          class="form-label mb-0 small">Core</label>
                                    <input type="number" class="form-control form-control-sm"
                                          id="tg-core-input" value="5"
                                          title="S·ªë session ch·∫°y song song trong m·ªôt ƒë·ª£t"
                                          style="width: 70px;">
                              </div>
                              <div>
                                    <label for="tg-delay-session-input"
                                          class="form-label mb-0 small">Delay/Session (s)</label>
                                    <input type="number" class="form-control form-control-sm"
                                          id="tg-delay-session-input" value="10"
                                          title="Kho·∫£ng c√°ch (gi√¢y) gi·ªØa c√°c session trong m·ªôt ƒë·ª£t"
                                          style="width: 70px;">
                              </div>
                              <div>
                                    <label for="tg-delay-batch-input"
                                          class="form-label mb-0 small">Delay/ƒê·ª£t (s)</label>
                                    <input type="number" class="form-control form-control-sm"
                                          id="tg-delay-batch-input" value="600"
                                          title="Kho·∫£ng c√°ch (gi√¢y) gi·ªØa c√°c ƒë·ª£t ch·∫°y"
                                          style="width: 70px;">
                              </div>
                              <div class="border-start ps-2">
                                    <div class="form-check form-switch mb-1">
                                          <input class="form-check-input" type="checkbox"
                                                role="switch" id="tg-admin-reply-switch">
                                          <label class="form-check-label small"
                                                for="tg-admin-reply-switch">Admin Tr·∫£ L·ªùi</label>
                    </div>
                                    <input type="number" class="form-control form-control-sm"
                                          id="tg-admin-delay-input" value="10"
                                          title="Delay cho Admin tr·∫£ l·ªùi (gi√¢y)" style="width: 70px;"
                                          disabled>
                    </div>
                              <button class="btn btn-primary fw-bold" id="tg-runStopBtn"
                                    data-task-running="false">
                                    <i class="bi bi-play-fill"></i> Run
                              </button>
                    </div>
                    </div>
                  <div class="d-flex gap-2 align-items-end flex-wrap">
                        <button class="btn btn-secondary" data-bs-toggle="modal"
                              data-bs-target="#tg-proxyModal">
                            <i class="bi bi-shield-shaded me-1"></i> Proxy
                        </button>
                        <button class="btn btn-success" data-bs-toggle="modal"
                              data-bs-target="#tg-addSessionModal"><i class="bi bi-plus-lg"></i> Add
                              Session</button>
                        <button class="btn btn-info" id="tg-checkLiveBtn"><i
                                    class="bi bi-broadcast"></i> Check Live</button>
                        <select class="form-select" id="tg-group-session-select"
                              style="width: 180px;"></select>
                    </div>
                    </div>
                </div>
      <div class="main-tool-container">
            <div class="nav flex-column nav-pills" id="tg-v-pills-tab" role="tablist">
                  <button class="nav-link active" id="tg-v-pills-session-manager-tab"
                        data-bs-toggle="pill" data-bs-target="#tg-v-pills-session-manager"
                        type="button" role="tab">ü§ñ Session Manager</button>
                  <button class="nav-link" id="tg-v-pills-group-tab" data-bs-toggle="pill"
                        data-bs-target="#tg-v-pills-group" type="button" role="tab"><i
                              class="bi bi-people-fill text-success me-2"></i>Group</button>
                  <button class="nav-link" id="tg-v-pills-automatic-tab" data-bs-toggle="pill"
                        data-bs-target="#tg-v-pills-automatic" type="button" role="tab">üîÑ
                        Automatic</button>
            </div>
            <div class="tab-content" id="tg-v-pills-tabContent">
                  <div class="tab-pane fade show active" id="tg-v-pills-session-manager"
                        role="tabpanel">
                        <div class="row" id="tg-session-tables-container">
                              <div class="col-12 mb-4">
                                    <div class="card" style="cursor: default;">
                                          <div class="card-body p-2">
                    <div class="table-responsive">
                                                      <table class="table table-striped">
                            <thead>
                                <tr>
                                                                        <th style="width: 5%;"><input
                                                                                    class="form-check-input tg-session-checkbox"
                                                                                    type="checkbox"
                                                                                    id="tg-selectAllCheckbox">
                                                                        </th>
                                                                        <th>STT</th>
                                                                        <th>Phone</th>
                                                                        <th class="d-none d-md-table-cell">Full Name</th>
                                                                        <th class="d-none d-md-table-cell">Username</th>
                                                                        <th class="text-center">
                                                                              <button class="btn btn-sm btn-success" id="tg-check-live-btn-header" title="Check Live">
                                                                                    <i class="bi bi-heartbeat-fill"></i> Check Live
                                                                              </button>
                                                                        </th>
                                                                        <th>Status</th>
                                </tr>
                            </thead>
                                                            <tbody id="tg-sessions-table-body">
                                                                  <tr>
                                                                        <td colspan="7" class="text-center text-muted">
                                                                              Vui l√≤ng ch·ªçn m·ªôt nh√≥m.
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
                  <div class="tab-pane fade" id="tg-v-pills-group" role="tabpanel">
                        <div class="row" id="tg-group-task-cards">
                              <div class="col-xl-3 col-md-6 mb-4">
                                    <div class="card h-100" data-task-id="joinGroup">
                                          <div class="card-body text-center d-flex flex-column">
                                                <h5 class="card-title"><i
                                                            class="bi bi-box-arrow-in-right me-2 text-primary"></i>Join
                                                      Group/Channel</h5>
                                                <p class="card-text small">Cho c√°c t√†i kho·∫£n ƒë√£ ch·ªçn
                                                      tham gia group.</p><button
                                                      class="btn btn-primary mt-auto"
                                                      onclick="tg_openConfigModal('joinGroup', event)">C·∫•u
                                                      h√¨nh</button>
                                          </div>
                                    </div>
                              </div>
                              <div class="col-xl-3 col-md-6 mb-4">
                                    <div class="card h-100" data-task-id="seedingGroup">
                                          <div class="card-body text-center d-flex flex-column">
                                                <h5 class="card-title"><i
                                                            class="bi bi-chat-dots-fill me-2 text-warning"></i>Seeding
                                                      Group</h5>
                                                <p class="card-text small">T·ª± ƒë·ªông t∆∞∆°ng t√°c, tr√≤
                                                      chuy·ªán trong group.</p><button
                                                      class="btn btn-warning mt-auto"
                                                      onclick="tg_openConfigModal('seedingGroup', event)">C·∫•u
                                                      h√¨nh</button>
                                          </div>
                                    </div>
                              </div>
                        </div>
                  </div>
                  <div class="tab-pane fade" id="tg-v-pills-automatic" role="tabpanel">
                        <div class="row">
                              <div class="col-lg-6 col-md-8">
                                    <div class="card">
                                          <div class="card-header d-flex align-items-center">
                                                <h5 class="mb-0"><i
                                                            class="bi-clock-history me-2"></i>Auto
                                                      Seeding</h5>
                                                <div id="auto-seeding-status-badge-container"
                                                      class="ms-3">
                                                      <span class="badge bg-secondary">ƒê√£ t·∫Øt</span>
            </div>

                                                <div class="d-flex align-items-center ms-auto gap-4">
                                                      <div class="form-check form-switch">
                                                            <input class="form-check-input"
                                                                  type="checkbox" role="switch"
                                                                  id="auto-seeding-daily">
                                                            <label class="form-check-label small"
                                                                  for="auto-seeding-daily">L·∫∑p l·∫°i m·ªói
                                                                  ng√†y</label>
                                                      </div>
                                                      <div class="form-check form-switch">
                                                            <input class="form-check-input"
                                                                  type="checkbox" role="switch"
                                                                  id="auto-seeding-enabled"
                                                                  style="transform: scale(1.3);">
                                                            <label class="form-check-label"
                                                                  for="auto-seeding-enabled">B·∫≠t</label>
                                                      </div>
                                                </div>
                                          </div>
                                          <div class="card-body">
                                                <div class="row g-3 mb-3">
                                                      <div class="col-auto">
                                                            <label class="form-label">Th·ªùi gian
                                                                  ch·∫°y:</label>
                                                            <div class="input-group">
                                                                  <input type="number"
                                                                        class="form-control auto-seeding-time-input"
                                                                        id="auto-seeding-hour"
                                                                        placeholder="Gi·ªù" min="1"
                                                                        max="12" style="width: 70px;">
                                                                  <span
                                                                        class="input-group-text p-1">:</span>
                                                                  <input type="number"
                                                                        class="form-control auto-seeding-time-input"
                                                                        id="auto-seeding-minute"
                                                                        placeholder="Ph√∫t" min="0"
                                                                        max="59" style="width: 77px;">
                                                                  <select class="form-select"
                                                                        id="auto-seeding-ampm"
                                                                        style="width: 80px;">
                                                                        <option value="AM">AM</option>
                                                                        <option value="PM" selected>PM
                                                                        </option>
                                                                  </select>
                                                            </div>
                                                      </div>
                                                      <div class="col-auto">
                                                            <label class="form-label">Th·ªùi gian k·∫øt
                                                                  th√∫c:</label>
                                                            <div class="input-group">
                                                                  <input type="number"
                                                                        class="form-control auto-seeding-time-input"
                                                                        id="auto-seeding-end-hour"
                                                                        placeholder="Gi·ªù" min="1"
                                                                        max="12" style="width: 70px;">
                                                                  <span
                                                                        class="input-group-text p-1">:</span>
                                                                  <input type="number"
                                                                        class="form-control auto-seeding-time-input"
                                                                        id="auto-seeding-end-minute"
                                                                        placeholder="Ph√∫t" min="0"
                                                                        max="59" style="width: 77px;">
                                                                  <select class="form-select"
                                                                        id="auto-seeding-end-ampm"
                                                                        style="width: 80px;">
                                                                        <option value="AM">AM</option>
                                                                        <option value="PM" selected>PM
                                                                        </option>
                                                                  </select>
                                                            </div>
                                                      </div>
                                                      <div class="col-auto ms-auto">
                                                            <label for="auto-seeding-group-select"
                                                                  class="form-label">Ch·ªçn
                                                                  Nh√≥m:</label>
                                                            <select id="auto-seeding-group-select"
                                                                  class="form-select"
                                                                  style="min-width: 200px;">
                                                                  <option value="">-- Ch·ªçn nh√≥m ƒë·ªÉ
                                                                        ch·∫°y --</option>
                                                            </select>
                                                      </div>
                                                </div>
                                                <div class="d-flex justify-content-end">
                                                      <button class="btn btn-primary"
                                                            id="save-auto-seeding-btn"><i
                                                                  class="bi bi-save me-1"></i> L∆∞u C√†i
                                                            ƒê·∫∑t</button>
                                                </div>
                                          </div>
                                    </div>
                              </div>
                        </div>
                  </div>
            </div>
      </div>
</div>

<!-- Telegram Modals -->
<div class="modal fade" id="tg-addSessionModal" tabindex="-1" data-bs-theme="dark">
      <div class="modal-dialog modal-lg">
            <div class="modal-content">
                  <div class="modal-header">
                        <h5 class="modal-title">Add / Manage Session Groups</h5><button type="button"
                              class="btn-close" data-bs-dismiss="modal"></button>
                  </div>
                  <div class="modal-body">
                        <h6><i class="bi bi-plus-circle-fill"></i> Th√™m nh√≥m m·ªõi</h6>
                        <form id="tg-addSessionForm" class="border p-3 rounded mb-4">
                              <div class="mb-3"><label class="form-label">T√™n nh√≥m</label><input type="text"
                                          class="form-control" id="tg-groupName" name="name" spellcheck="false"
                                          required>
                                    <div class="form-text">ƒê·ªÉ t·∫°o nh√≥m admin, ƒë·∫∑t t√™n l√† <b>Adminsession</b></div>
                              </div>
                              <div class="mb-3"><label class="form-label">Ch·ªçn file .session</label><input
                                          class="form-control" type="file" id="tg-sessionFiles"
                                          name="session_files" multiple accept=".session"></div><button
                                    type="button" class="btn btn-primary w-100" id="tg-saveGroupBtn">L∆∞u
                                    l·∫°i</button>
                        </form>
                        <hr>
                        <h6><i class="bi bi-list-ul"></i> C√°c nh√≥m hi·ªán c√≥</h6>
                        <div id="tg-existing-groups-list" class="d-flex flex-column gap-2"
                              style="max-height: 200px; overflow-y: auto;"></div>
                  </div>
            </div>
      </div>
</div>

<div class="modal fade" id="tg-joinGroupModal" tabindex="-1" data-bs-theme="dark">
      <div class="modal-dialog">
            <div class="modal-content">
                  <div class="modal-header">
                        <h5 class="modal-title"><i class="bi bi-box-arrow-in-right me-2"></i>C·∫•u h√¨nh Join Group
                        </h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                  </div>
                  <div class="modal-body"><label class="form-label"><strong>Danh s√°ch
                                    link:</strong></label><textarea class="form-control" id="tg-joinGroupLinks"
                              spellcheck="false" rows="8"></textarea></div>
                  <div class="modal-footer"><button type="button" class="btn btn-secondary"
                              data-bs-dismiss="modal">ƒê√≥ng</button><button type="button" class="btn btn-primary"
                              id="tg-saveJoinGroupConfigBtn">L∆∞u</button></div>
            </div>
      </div>
</div>

<div class="modal fade" id="tg-seedingGroupModal" tabindex="-1" data-bs-theme="dark">
      <div class="modal-dialog modal-lg">
            <div class="modal-content">
                  <div class="modal-header">
                        <h5 class="modal-title"><i class="bi bi-chat-dots-fill me-2"></i>C·∫•u h√¨nh Seeding</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                  </div>
                  <div class="modal-body">
                        <div class="row">
                              <div class="col-md-6">
                                    <div class="mb-3"><label class="form-label"><strong>Link
                                                      nh√≥m:</strong></label><textarea class="form-control"
                                                id="tg-seedingGroupLinks" spellcheck="false" rows="5"></textarea>
                                    </div>
                              </div>
                              <div class="col-md-6">
                                    <div class="mb-3"><label class="form-label"><strong>Tin nh·∫Øn (Session th√†nh
                                                      vi√™n):</strong></label><textarea class="form-control"
                                                id="tg-seedingGroupMessages" spellcheck="false"
                                                rows="5"></textarea></div>
                                    <div class="mb-3"><label class="form-label"><strong>Tin nh·∫Øn
                                                      (Admin):</strong></label><textarea class="form-control"
                                                id="tg-seedingAdminMessages" spellcheck="false"
                                                rows="5"></textarea></div>
                              </div>
                        </div>
                  </div>
                  <div class="modal-footer">
                        <div class="me-auto d-flex gap-2 align-items-center">
                              <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" role="switch"
                                          id="tg-seedingSilentSwitch">
                                    <label class="form-check-label" for="tg-seedingSilentSwitch">G·ª≠i kh√¥ng
                                          ti·∫øng</label>
                              </div>
                              <button type="button" class="btn btn-sm btn-outline-info"
                                    id="tg-shuffleMessagesBtn"><i class="bi bi-shuffle"></i> X√°o tr·ªôn</button>
                              <label for="tg-uploadAdminSession" class="btn btn-outline-primary btn-sm"><i
                                          class="bi bi-upload"></i> Upload Admin</label>
                              <input type="file" id="tg-uploadAdminSession" name="admin_session_files"
                                    accept=".session" style="display: none;" multiple>
                              <select class="form-select form-select-sm d-inline-block"
                                    id="tg-seedingAdminSessionSelect" style="width: auto;">
                                    <option value="">-- Kh√¥ng d√πng Admin --</option>
                              </select>
                        </div>
                        <div><button type="button" class="btn btn-secondary"
                                    data-bs-dismiss="modal">ƒê√≥ng</button><button type="button"
                                    class="btn btn-warning" id="tg-saveSeedingGroupConfigBtn">L∆∞u</button></div>
                  </div>
            </div>
      </div>
</div>

<div class="modal fade" id="tg-deleteDeadSessionsModal" tabindex="-1" data-bs-theme="dark">
      <div class="modal-dialog">
            <div class="modal-content">
                  <div class="modal-header">
                        <h5 class="modal-title">X√°c nh·∫≠n x√≥a Session</h5><button type="button" class="btn-close"
                              data-bs-dismiss="modal"></button>
                  </div>
                  <div class="modal-body">
                        <p id="tg-deleteDeadSessionsModalBody"></p>
                  </div>
                  <div class="modal-footer"><button type="button" class="btn btn-secondary"
                              data-bs-dismiss="modal">H·ªßy</button><button type="button" class="btn btn-danger"
                              id="tg-confirmDeleteDeadBtn">X√≥a</button></div>
            </div>
      </div>
</div>

<div class="modal fade" id="tg-proxyModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-shield-shaded me-1"></i>Qu·∫£n L√Ω Proxy</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                        <p class="text-muted small">Nh·∫≠p danh s√°ch proxy theo ƒë·ªãnh d·∫°ng `ip:port:user:pass` ho·∫∑c
                              `ip:port`, m·ªói proxy m·ªôt d√≤ng.</p>
                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" role="switch" id="tg-proxy-enabled">
                              <label class="form-check-label" for="tg-proxy-enabled">S·ª≠ d·ª•ng Proxy cho c√°c t√°c
                                    v·ª•</label>
                </div>
                        <textarea class="form-control" id="tg-proxy-list" rows="10" spellcheck="false"
                              placeholder="171.236.161.237:23270:user:pass..."></textarea>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                <button type="button" class="btn btn-primary" id="tg-save-proxy-btn">L∆∞u Proxy</button>
            </div>
            </div>
      </div>
</div>

<!-- Telegram Context Menu -->
<div id="telegram-context-menu" class="custom-context-menu">
  <div class="menu-item" onclick="console.log('Add Session')">Add Session</div>
  <div class="menu-item" onclick="console.log('Scrape Users')">Scrape Users</div>
  <div class="menu-item" onclick="console.log('Send Message')">Send Message</div>
      <div class="menu-item" id="tg-context-delete-session"><i class="bi bi-trash"></i> X√≥a Session</div>
</div>

<script>
// üîç DEBUG: Telegram script loading
console.log('üîç Loading Telegram script...');

// --- TELEGRAM MANAGER SCRIPT ---
(async () => {
      const telegramPane = document.getElementById('telegram-tool-pane');
      if (!telegramPane) {
            console.log('üîç Telegram pane not found!');
            return;
      }
      console.log('üîç Telegram pane found, initializing...');

      // --- START: REFACTORED SCRIPT BLOCK FOR AUTO-SAVING UI STATE ---

      const adminSwitch = document.getElementById('tg-admin-reply-switch');
      const adminDelayInput = document.getElementById('tg-admin-delay-input');
      const globalSettingInputs = [
            document.getElementById('tg-core-input'),
            document.getElementById('tg-delay-session-input'),
            document.getElementById('tg-delay-batch-input'),
            adminSwitch,
            adminDelayInput
      ];

      let autoSaveTimer = null;

      // Function to load and populate the main control bar settings from the database.
      async function loadTelegramGlobalSettings() {
            console.log('üîç Loading Telegram global settings...');
            try {
                  const response = await fetch('/automatic/api/seeding/settings');
                  if (!response.ok) return;
                  const settings = await response.json();

                  if (Object.keys(settings).length > 0) {
                        document.getElementById('tg-core-input').value = settings.core || 5;
                        document.getElementById('tg-delay-session-input').value = settings.delay_per_session || 10;
                        document.getElementById('tg-delay-batch-input').value = settings.delay_between_batches || 600;
                        adminSwitch.checked = settings.admin_enabled || false;
                        adminDelayInput.value = settings.admin_delay || 10;
                        adminDelayInput.disabled = !adminSwitch.checked;
                  }
                  console.log('üîç Telegram settings loaded:', settings);
            } catch (error) {
                  console.error("üîç Could not load global Telegram settings:", error);
            }
      }

      // The auto-save function with debouncing.
      function triggerAutoSave() {
            clearTimeout(autoSaveTimer); // Reset the timer on every change
            autoSaveTimer = setTimeout(async () => {
                  const payload = {
                        core: parseInt(document.getElementById('tg-core-input').value, 10),
                        delay_per_session: parseInt(document.getElementById('tg-delay-session-input').value, 10),
                        delay_between_batches: parseInt(document.getElementById('tg-delay-batch-input').value, 10),
                        admin_enabled: document.getElementById('tg-admin-reply-switch').checked,
                        admin_delay: parseInt(document.getElementById('tg-admin-delay-input').value, 10)
                  };

                  try {
                        console.log('üîç Auto-saving Telegram settings:', payload);
                        const response = await fetch('/telegram/api/global-settings', {
                              method: 'POST',
                              headers: { 'Content-Type': 'application/json' },
                              body: JSON.stringify(payload)
                        });
                        const result = await response.json();
                        if (!response.ok) throw new Error(result.error || 'L·ªói server');
                        showToast('C√†i ƒë·∫∑t chung ƒë√£ ƒë∆∞·ª£c t·ª± ƒë·ªông l∆∞u.', 'success');
                  } catch (error) {
                        showToast(`L·ªói t·ª± ƒë·ªông l∆∞u: ${error.message}`, 'error');
                  }
            }, 1500); // Wait 1.5 seconds after the last change before saving
      }

      // Attach event listeners for auto-saving
      globalSettingInputs.forEach(input => {
            if (input) {
                  input.addEventListener('input', triggerAutoSave); // For text/number inputs
                  input.addEventListener('change', triggerAutoSave); // For checkboxes/switches
            }
      });

      // Event listener to show/hide the admin delay input when the toggle is clicked.
      if (adminSwitch) {
            adminSwitch.addEventListener('change', () => {
                  adminDelayInput.disabled = !adminSwitch.checked;
            });
      }

      // Load settings on page load
      loadTelegramGlobalSettings();

      // --- END: REFACTORED SCRIPT BLOCK FOR AUTO-SAVING UI STATE ---

      let tg_pollingInterval = null, tg_currentTaskId = null, tg_lastCheckedCheckbox = null,
            tg_currentTaskConfig = {}, tg_completedInTask = new Set(), tg_allGroups = [];

      async function tg_handleRunStopClick(event) {
            const button = event.currentTarget;
            if (button.dataset.taskRunning === 'true') {
                  if (!tg_currentTaskId) return;
                  try {
                        console.log('üîç Stopping task:', tg_currentTaskId);
                        await fetch(`/telegram/api/stop-task/${tg_currentTaskId}`, { method: 'POST' });
                  } catch (error) { showToast(`L·ªói khi d·ª´ng: ${error.message}`, 'error'); }
            } else {
                  const isGroupTaskSelected = tg_currentTaskConfig && tg_currentTaskConfig.task && ['seedingGroup', 'joinGroup'].includes(tg_currentTaskConfig.task);
                  if (isGroupTaskSelected) {
                        await tg_handleRunGroupTask();
                  } else {
                        await tg_handleCheckLive();
                  }
            }
      }

      async function tg_handleRunGroupTask() {
            console.log('üîç Running group task...');
            const selectedFilenames = Array.from(telegramPane.querySelectorAll('.tg-session-checkbox:checked:not(#tg-selectAllCheckbox)')).map(cb => cb.closest('tr').dataset.filename);
            let sessionsForTask = selectedFilenames;
            if (sessionsForTask.length === 0 && tg_currentTaskConfig.task === 'seedingGroup' && tg_currentTaskConfig.session_filenames?.length > 0) {
                  sessionsForTask = tg_currentTaskConfig.session_filenames;
                  showToast('Kh√¥ng c√≥ session n√†o ƒë∆∞·ª£c ch·ªçn. S·ª≠ d·ª•ng danh s√°ch ƒë√£ l∆∞u trong c·∫•u h√¨nh.', 'info');
            }
            if (sessionsForTask.length === 0) return showToast('Vui l√≤ng ch·ªçn ho·∫∑c l∆∞u session trong c·∫•u h√¨nh.', 'error');

            const payload = {
                  groupId: document.getElementById('tg-group-session-select').value,
                  task: tg_currentTaskConfig.task,
                  config: tg_currentTaskConfig,
                  filenames: sessionsForTask,
                  core: parseInt(document.getElementById('tg-core-input').value, 10),
                  delay_per_session: parseInt(document.getElementById('tg-delay-session-input').value, 10),
                  delay_between_batches: parseInt(document.getElementById('tg-delay-batch-input').value, 10),
                  admin_enabled: document.getElementById('tg-admin-reply-switch').checked,
                  admin_delay: parseInt(document.getElementById('tg-admin-delay-input').value, 10)
            };

            if (!payload.groupId) return showToast('Vui l√≤ng ch·ªçn nh√≥m session.', 'error');

            const taskDesc = telegramPane.querySelector('#tg-group-task-cards .card.card-selected .card-title')?.textContent.trim() || "t√°c v·ª•";
            tg_startTaskUI(sessionsForTask.length, `B·∫Øt ƒë·∫ßu "${taskDesc}"...`);
            try {
                  console.log('üîç Running task payload:', payload);
                  const response = await fetch('/telegram/api/run-task', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                  if (!response.ok) throw new Error((await response.json()).error || 'L·ªói server.');
                  const { task_id } = await response.json();
                  tg_currentTaskId = task_id;
                  console.log('üîç Task started with ID:', task_id);
                  tg_setRunStopButtonState('running');
                  tg_pollTaskStatus(tg_currentTaskId);
            } catch (error) { showToast(`L·ªói: ${error.message}`, 'error'); tg_setRunStopButtonState('idle'); }
      }

      // START: Replacement for tg_handleCheckLive
      async function tg_handleCheckLive() {
            console.log('üîç Check Live initiated...');
            if (tg_pollingInterval) return showToast('T√°c v·ª• kh√°c ƒëang ch·∫°y.', 'error');

            const groupId = document.getElementById('tg-group-session-select').value;
            if (!groupId) return showToast('Vui l√≤ng ch·ªçn nh√≥m.', 'error');

            const selectedFilenames = Array.from(telegramPane.querySelectorAll('.tg-session-checkbox:checked:not(#tg-selectAllCheckbox)')).map(cb => cb.closest('tr').dataset.filename);
            if (selectedFilenames.length === 0) return showToast('Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt session.', 'error');

            // Deselect any group task cards to avoid confusion
            telegramPane.querySelectorAll('#tg-group-task-cards .card').forEach(d => d.classList.remove('card-selected'));
            tg_currentTaskConfig = {};

            const payload = {
                  groupId: groupId,
                  task: "check-live", // Set the correct task name
                  filenames: selectedFilenames,
                  core: parseInt(document.getElementById('tg-core-input').value, 10),
                  delay_per_session: parseInt(document.getElementById('tg-delay-session-input').value, 10),
                  delay_between_batches: parseInt(document.getElementById('tg-delay-batch-input').value, 10),
                  admin_enabled: false, // Not applicable for check-live
                  admin_delay: 0      // Not applicable for check-live
            };

            tg_startTaskUI(selectedFilenames.length, `B·∫Øt ƒë·∫ßu Check Live...`);

            try {
                  console.log('üîç Check Live payload:', payload);
                  // Call the correct, generic run-task endpoint
                  const response = await fetch('/telegram/api/run-task', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                  });

                  if (!response.ok) throw new Error((await response.json()).error || 'L·ªói server.');

                  const { task_id } = await response.json();
                  tg_currentTaskId = task_id;
                  console.log('üîç Check Live started with ID:', task_id);
                  tg_setRunStopButtonState('running');
                  tg_pollTaskStatus(tg_currentTaskId);

            } catch (error) {
                  showToast(`L·ªói: ${error.message}`, 'error');
                  tg_setRunStopButtonState('idle');
      }
      }
      // END: Replacement for tg_handleCheckLive

      function tg_startTaskUI(total, msg) {
            tg_completedInTask.clear();
            showToast(msg, 'info');
            document.getElementById('tg-status-success-count').textContent = '0';
            document.getElementById('tg-status-failed-count').textContent = '0';
            document.getElementById('tg-status-progress-text').textContent = `0/${total}`;
            // üîç FIX: Kh√¥ng thay ƒë·ªïi Status cell n·ªØa, ch·ªâ hi·ªÉn th·ªã progress ·ªü header
      }

      function tg_setRunStopButtonState(state) {
            const button = document.getElementById('tg-runStopBtn');
            const statusText = document.getElementById('tg-status-progress-text');
            if (state === 'running') {
                  button.dataset.taskRunning = 'true';
                  statusText.dataset.taskRunning = 'true';
                  button.innerHTML = `<i class="bi bi-stop-fill"></i> Stop`;
                  button.classList.replace('btn-primary', 'btn-danger');
            } else {
                  button.dataset.taskRunning = 'false';
                  statusText.dataset.taskRunning = 'false';
                  button.innerHTML = `<i class="bi bi-play-fill"></i> Run`;
                  button.classList.replace('btn-danger', 'btn-primary');
            }
      }

      function tg_pollTaskStatus(taskId) {
            if (tg_pollingInterval) clearInterval(tg_pollingInterval);
            tg_pollingInterval = setInterval(async () => {
                  if (!tg_currentTaskId) { clearInterval(tg_pollingInterval); return; }
                  try {
                        const response = await fetch(`/telegram/api/task-status/${taskId}`);
                        if (!response.ok) { clearInterval(tg_pollingInterval); tg_setRunStopButtonState('idle'); return; }
                        const task = await response.json();
                        tg_updateUiWithTaskProgress(task);
                        if (task.status === 'completed' || task.status === 'stopped') {
                              clearInterval(tg_pollingInterval);
                              tg_pollingInterval = null; tg_currentTaskId = null;
                              showToast(task.status === 'completed' ? 'Ho√†n t·∫•t t√°c v·ª•!' : 'T√°c v·ª• ƒë√£ d·ª´ng.', 'success');
                              document.getElementById('tg-status-progress-text').textContent = "Idle";
                              tg_setRunStopButtonState('idle');
                              tg_updateSessionCountDisplay();
                        }
                  } catch (error) { clearInterval(tg_pollingInterval); console.error('L·ªói khi polling:', error); tg_setRunStopButtonState('idle'); }
            }, 1500);
      }
      function tg_updateUiWithTaskProgress(task) {
            document.getElementById('tg-status-progress-text').textContent = `${task.processed}/${task.total}`;
            document.getElementById('tg-status-success-count').textContent = task.success;
            document.getElementById('tg-status-failed-count').textContent = task.failed;

            // Update status for completed sessions in this poll
            task.results.forEach(result => {
                  const row = telegramPane.querySelector(`tr[data-filename="${result.filename}"]`);
                  if (!row) return;

                  tg_completedInTask.add(result.filename); // Mark this session as processed

                  if (result.full_name) row.cells[3].textContent = result.full_name;
                  if (result.username) row.cells[4].textContent = result.username;
                  
                  // üîç FIX: Hi·ªÉn th·ªã Live/Die icon v·ªõi badge
                  row.cells[5].innerHTML = result.is_live 
                        ? `<span class="badge bg-success"><i class="bi bi-check-circle-fill"></i> Live</span>` 
                        : `<span class="badge bg-danger"><i class="bi bi-x-circle-fill"></i> Die</span>`;
                  
                  // üîç FIX: Status cell gi·ªØ nguy√™n kh√¥ng ƒë·ªïi, ch·ªâ hi·ªÉn th·ªã status_text
                  row.cells[6].innerHTML = `<span class="text-info">${result.status_text}</span>`;
            });

            // üîç FIX: Handle global task messages (hi·ªÉn th·ªã ·ªü header, kh√¥ng c·∫≠p nh·∫≠t Status cell)
            if (task.messages && task.messages.length > 0) {
                  const latestMessage = task.messages[task.messages.length - 1];
                  document.getElementById('tg-status-progress-text').textContent = latestMessage;
            }
      }

      async function tg_loadGroups() {
            console.log('üîç Loading Telegram groups...');
            try {
                  const r = await fetch('/telegram/api/groups');
                  tg_allGroups = await r.json();
                  const s = document.getElementById('tg-group-session-select');
                  s.innerHTML = '<option selected disabled>-- Ch·ªçn nh√≥m --</option>';
                  tg_allGroups.forEach(g => {
                        if (g.name !== 'Adminsession') s.add(new Option(g.name, g.id));
                  });
                  const storedId = localStorage.getItem('tg_selectedGroupId');
                  // Check if the stored ID exists and corresponds to a valid, non-admin group in the list
                  if (storedId && tg_allGroups.some(g => g.id == storedId && g.name !== 'Adminsession')) {
                        s.value = storedId;
                        // CRITICAL FIX: Programmatically trigger the 'change' event to force session loading.
                        // The 'await' is important as the event handler is async.
                        await s.dispatchEvent(new Event('change'));
                  }
                  console.log('üîç Groups loaded:', tg_allGroups);
            } catch (e) { showToast('Kh√¥ng th·ªÉ t·∫£i nh√≥m Telegram.', 'error'); }
      }

      async function tg_handleGroupSelect(e) {
            tg_lastCheckedCheckbox = null;
            const groupId = e.target.value;
            console.log('üîç Group selected:', groupId);
            localStorage.setItem('tg_selectedGroupId', groupId);
            const tableBody = document.getElementById('tg-sessions-table-body');
            tableBody.innerHTML = `<tr><td colspan="7" class="text-center"><div class="spinner-border spinner-border-sm"></div></td></tr>`;
            try {
                  const res = await fetch(`/telegram/api/groups/${groupId}/sessions`);
                  tg_renderSessions(await res.json());
            } catch (e) {
                  tableBody.innerHTML = `<tr><td colspan="7" class="text-danger text-center">L·ªói t·∫£i session</td></tr>`;
            }
      }

      function tg_renderSessions(sessions) {
            const tableBody = document.getElementById('tg-sessions-table-body');
            tableBody.innerHTML = ''; // Clear the single body
            document.getElementById('tg-total-sessions-count').textContent = sessions.length;
            const rowHtml = (s, i) => {
                  // Live/Die icons
                  const liveIcon = s.is_live === null 
                        ? '<i class="bi bi-question-circle-fill text-secondary"></i>' 
                        : (s.is_live 
                              ? '<span class="badge bg-success"><i class="bi bi-check-circle-fill"></i> Live</span>' 
                              : '<span class="badge bg-danger"><i class="bi bi-x-circle-fill"></i> Die</span>');
                  
                  return `<tr data-filename="${s.filename}">
                        <td><input class="form-check-input tg-session-checkbox" type="checkbox"></td>
                        <td>${i + 1}</td>
                        <td>${s.phone}</td>
                        <td class="d-none d-md-table-cell" style="cursor: text;">${s.full_name || 'N/A'}</td>
                        <td class="d-none d-md-table-cell" style="cursor: text;">${s.username || ''}</td>
                        <td class="text-center">${liveIcon}</td>
                        <td><span class="text-info">${s.status_text || 'S·∫µn s√†ng'}</span></td>
                  </tr>`;
            };
            // Render all sessions into the single table body. No more splitting.
            tableBody.innerHTML = sessions.map((s, i) => rowHtml(s, i)).join('');
            tg_updateSessionCountDisplay();
            console.log('üîç Sessions rendered:', sessions.length);
      }

      function tg_updateSessionCountDisplay() {
            const statusEl = document.getElementById('tg-status-progress-text');
            if (statusEl && statusEl.dataset.taskRunning !== 'true') {
                  const selected = telegramPane.querySelectorAll('.tg-session-checkbox:checked').length;
                  const total = telegramPane.querySelectorAll('.tg-session-checkbox').length;
                  statusEl.textContent = selected > 0 ? `${selected}/${total} Selected` : 'Idle';
            }
      }

      window.tg_openConfigModal = async (taskId, event) => {
            if (event) event.stopPropagation();
            await tg_selectCardAndLoadConfig(taskId);
            const modalId = `tg-${taskId}Modal`;
            const configModal = document.getElementById(modalId);
            if (configModal) {
                  if (taskId === 'joinGroup') tg_populateJoinGroupModal();
                  if (taskId === 'seedingGroup') await tg_populateSeedingGroupModal();
                  new bootstrap.Modal(configModal).show();
            }
      };

      async function tg_selectCardAndLoadConfig(taskId) {
            telegramPane.querySelectorAll('#tg-group-task-cards .card').forEach(d => d.classList.remove('card-selected'));
            const card = telegramPane.querySelector(`#tg-group-task-cards .card[data-task-id="${taskId}"]`);
            if (card) card.classList.add('card-selected');
            localStorage.setItem('tg_lastSelectedTask', taskId);
            try {
                  const response = await fetch(`/telegram/api/config/${taskId}`);
                  tg_currentTaskConfig = response.ok ? await response.json() : {};
                  tg_currentTaskConfig.task = taskId;
            } catch (error) { tg_currentTaskConfig = { task: taskId }; }
      }

      function tg_populateJoinGroupModal() { document.getElementById('tg-joinGroupLinks').value = (tg_currentTaskConfig?.links || []).join('\n'); }

      async function tg_populateSeedingGroupModal() {
            const { group_links, messages, admin_messages, admin_session_file } = tg_currentTaskConfig;
            document.getElementById('tg-seedingGroupLinks').value = (group_links || []).join('\n');
            document.getElementById('tg-seedingGroupMessages').value = (messages || []).join('\n');
            document.getElementById('tg-seedingAdminMessages').value = (admin_messages || []).join('\n');

            document.getElementById('tg-seedingSilentSwitch').checked = tg_currentTaskConfig?.send_silent || false;
            const adminSelect = document.getElementById('tg-seedingAdminSessionSelect');
            adminSelect.innerHTML = '<option value="">-- ƒêang t·∫£i... --</option>';
            const adminGroup = tg_allGroups.find(g => g.name === 'Adminsession');
            if (!adminGroup) { adminSelect.innerHTML = '<option value="">-- Kh√¥ng c√≥ nh√≥m Adminsession --</option>'; return; }
            try {
                  const res = await fetch(`/telegram/api/groups/${adminGroup.id}/sessions`);
                  const adminSessions = await res.json();
                  adminSelect.innerHTML = '<option value="">-- Kh√¥ng s·ª≠ d·ª•ng Admin --</option>';
                  adminSessions.forEach(s => adminSelect.add(new Option(s.phone || s.filename, s.filename)));
                  if (admin_session_file) adminSelect.value = admin_session_file;
            } catch (error) { adminSelect.innerHTML = '<option value="">-- L·ªói t·∫£i session --</option>'; }
      }

      async function tg_saveJoinGroupConfig() {
            const links = document.getElementById('tg-joinGroupLinks').value.trim().split(/\r?\n/).filter(Boolean);
            const configToSave = { links };
            try {
                  await fetch('/telegram/api/config/joinGroup', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(configToSave) });
                  tg_currentTaskConfig = { ...tg_currentTaskConfig, ...configToSave };
                  bootstrap.Modal.getInstance(document.getElementById('tg-joinGroupModal')).hide();
                  showToast('ƒê√£ l∆∞u c·∫•u h√¨nh Join Group!', 'success');
            } catch (error) { showToast(`L·ªói: ${error.message}`, 'error'); }
      }

      async function tg_saveSeedingGroupConfig() {
            const configToSave = {
                  group_links: document.getElementById('tg-seedingGroupLinks').value.trim().split(/\r?\n/).filter(Boolean),
                  messages: document.getElementById('tg-seedingGroupMessages').value.trim().split(/\r?\n/).filter(Boolean),
                  admin_messages: document.getElementById('tg-seedingAdminMessages').value.trim().split(/\r?\n/).filter(Boolean),
                  admin_session_file: document.getElementById('tg-seedingAdminSessionSelect').value,
                  session_filenames: Array.from(telegramPane.querySelectorAll('.tg-session-checkbox:checked:not(#tg-selectAllCheckbox)')).map(cb => cb.closest('tr').dataset.filename),
                  send_silent: document.getElementById('tg-seedingSilentSwitch').checked
            };
            try {
                  await fetch('/telegram/api/config/seedingGroup', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(configToSave) });
                  tg_currentTaskConfig = { ...tg_currentTaskConfig, ...configToSave };
                  bootstrap.Modal.getInstance(document.getElementById('tg-seedingGroupModal')).hide();
                  showToast('ƒê√£ l∆∞u c·∫•u h√¨nh Seeding Group!', 'success');
            } catch (error) { showToast(`L·ªói: ${error.message}`, 'error'); }
      }

      async function tg_handleSaveGroup(event) {
            event.preventDefault();
            const form = document.getElementById('tg-addSessionForm');
            const nameInput = document.getElementById('tg-groupName');
            const filesInput = document.getElementById('tg-sessionFiles');
            if (!nameInput.value.trim() || !filesInput.files.length) return showToast('Vui l√≤ng nh·∫≠p t√™n nh√≥m v√† ch·ªçn file.', 'error');
            const formData = new FormData(form);
            try {
                  const r = await fetch('/telegram/api/groups', { method: 'POST', body: formData });
                  const j = await r.json();
                  if (!r.ok) throw new Error(j.error || 'L·ªói server.');
                  showToast(j.message || 'Th√†nh c√¥ng!', 'success');
                  bootstrap.Modal.getInstance(document.getElementById('tg-addSessionModal')).hide();
                  form.reset();
                  await tg_loadGroups();
            } catch (e) { showToast(`L·ªói: ${e.message}`, 'error'); }
      }

      async function tg_handleUploadAdminSession() {
            const files = this.files;
            if (!files.length) return;
            const formData = new FormData();
            for (const file of files) formData.append('admin_session_files', file);
            try {
                  const response = await fetch('/telegram/api/upload-admin-sessions', { method: 'POST', body: formData });
                  const result = await response.json();
                  if (!response.ok) throw new Error(result.error);
                  showToast(result.message, 'success');
                  await tg_loadGroups();
                  await tg_populateSeedingGroupModal();
            } catch (error) { showToast(`L·ªói: ${error.message}`, 'error'); }
      }
      async function tg_resumeActiveTasks() {
            try {
                  const response = await fetch('/telegram/api/active-tasks');
                  if (!response.ok) return;
                  const activeTasks = await response.json();
                  const taskIds = Object.keys(activeTasks);
                  if (taskIds.length > 0) {
                        const taskIdToResume = taskIds[0];
                        const taskData = activeTasks[taskIdToResume];
                        showToast(`Kh√¥i ph·ª•c tr·∫°ng th√°i t√°c v·ª•: ${taskData.task_name}`, 'info');
                        tg_currentTaskId = taskIdToResume;
                        document.getElementById('tg-status-success-count').textContent = taskData.success;
                        document.getElementById('tg-status-failed-count').textContent = taskData.failed;
                        document.getElementById('tg-status-progress-text').textContent = `${taskData.processed}/${taskData.total}`;
                        const groupSelect = document.getElementById('tg-group-session-select');
                        // Set the group select dropdown to the group associated with the resumed task
                                    groupSelect.value = taskData.group_id;
                        // CRITICAL FIX: Trigger the change event to load and display the sessions for that group.
                                    await groupSelect.dispatchEvent(new Event('change'));
                        tg_setRunStopButtonState('running');
                        tg_pollTaskStatus(taskIdToResume);
                  }
            } catch (error) { console.error("L·ªói khi kh√¥i ph·ª•c t√°c v·ª•:", error); }
      }

      document.getElementById('tg-runStopBtn').addEventListener('click', tg_handleRunStopClick);
      document.getElementById('tg-checkLiveBtn').addEventListener('click', tg_handleCheckLive);
      document.getElementById('tg-check-live-btn-header').addEventListener('click', tg_handleCheckLive); // Header button
      document.getElementById('tg-group-session-select').addEventListener('change', tg_handleGroupSelect);
      document.getElementById('tg-saveGroupBtn').addEventListener('click', tg_handleSaveGroup);
      document.getElementById('tg-saveJoinGroupConfigBtn').addEventListener('click', tg_saveJoinGroupConfig);
      document.getElementById('tg-saveSeedingGroupConfigBtn').addEventListener('click', tg_saveSeedingGroupConfig);
      document.getElementById('tg-uploadAdminSession').addEventListener('change', tg_handleUploadAdminSession);
      // Delete Dead Sessions Function
      window.tg_deleteDeadSessions = async () => {
            // Determine current groupId
            const groupSelect = document.getElementById('tg-group-session-select');
            const groupId = groupSelect?.value || '';
            if (!groupId) {
                  alert('Vui l√≤ng ch·ªçn nh√≥m.');
                  return;
            }

            // Collect all "dead" sessions from the table
            const rows = [
                  ...document.querySelectorAll('#tg-sessions-table-body tr[data-live="false"]')
            ];
            const filenames = rows.map(r => r.dataset.filename).filter(Boolean);

            if (filenames.length === 0) {
                  alert('Kh√¥ng c√≥ session die ƒë·ªÉ x√≥a.');
                  return;
            }

            // Guard when a task is running
            const runBtn = document.getElementById('tg-runStopBtn');
            if (runBtn && runBtn.dataset.taskRunning === 'true') {
                  alert('ƒêang ch·∫°y t√°c v·ª•, vui l√≤ng d·ª´ng tr∆∞·ªõc khi x√≥a.');
                  return;
            }

            // Confirm
            if (!confirm(`X√≥a ${filenames.length} session die kh·ªèi nh√≥m v√† kh·ªèi ƒëƒ©a?`)) {
                  return;
            }

            try {
                  // Call backend
                  const res = await fetch('/telegram/api/sessions/delete', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ group_id: groupId, filenames })
                  });

                  if (!res.ok) {
                        const err = await res.json().catch(() => ({}));
                        throw new Error(err.message || `HTTP ${res.status}`);
                  }

                  const { deleted = [], missing = [], failed = [] } = await res.json();

                  // Update UI by reloading sessions
                  const tableBody = document.getElementById('tg-sessions-table-body');
                  tableBody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">Loading...</td></tr>';

                  const sessionsRes = await fetch(`/telegram/api/groups/${groupId}/sessions`);
                  tg_renderSessions(await sessionsRes.json());

                  // Notify result
                  if (failed.length > 0) {
                        alert(`Kh√¥ng th·ªÉ x√≥a ${failed.length} session.`);
                  } else {
                        console.log('Deleted sessions:', deleted);
                  }

            } catch (error) {
                  alert(`L·ªói x√≥a session: ${error.message}`);
            }
      };

      // Attach event handler for delete sessions context menu
      document.getElementById('tg-context-delete-session')?.addEventListener('click', async () => {
            if (typeof hideAllContextMenus === 'function') hideAllContextMenus();
            try {
                  await tg_deleteDeadSessions();
            } catch (e) {
                  alert(`L·ªói x√≥a session: ${e.message}`);
            }
      });

      // Immediately load groups and check for active tasks on page load.
      (async () => {
            await tg_loadGroups();
            await tg_resumeActiveTasks();
      })();

      document.getElementById('tg-shuffleMessagesBtn').addEventListener('click', () => {
            const memberTextarea = document.getElementById('tg-seedingGroupMessages');
            const adminTextarea = document.getElementById('tg-seedingAdminMessages');
            const shuffleTextarea = (textarea) => {
                  let lines = textarea.value.split('\n').filter(line => line.trim() !== '');
                  for (let i = lines.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [lines[i], lines[j]] = [lines[j], lines[i]];
                  }
                  textarea.value = lines.join('\n');
            };
            shuffleTextarea(memberTextarea);
            shuffleTextarea(adminTextarea);
            showToast('ƒê√£ x√°o tr·ªôn tin nh·∫Øn!', 'success');
      });

      document.getElementById('tg-group-task-cards').addEventListener('click', e => {
            const card = e.target.closest('.card[data-task-id]');
            if (card && !e.target.closest('button')) {
                  tg_selectCardAndLoadConfig(card.dataset.taskId);
            }
      });
      document.getElementById('tg-session-tables-container').addEventListener('click', e => {
            const checkbox = e.target;

            // First, handle the specific "Select All" case
            if (checkbox.id === 'tg-selectAllCheckbox') {
                  const allSessionCheckboxes = telegramPane.querySelectorAll('.tg-session-checkbox:not(#tg-selectAllCheckbox)');
                  allSessionCheckboxes.forEach(cb => {
                        if (!cb.disabled) {
                              cb.checked = checkbox.checked;
                        }
                  });
                  tg_updateSessionCountDisplay();

                  // THEN, handle clicks on individual session checkboxes
            } else if (checkbox.classList.contains('tg-session-checkbox')) {
                  if (e.shiftKey && tg_lastCheckedCheckbox) {
                        const allCheckboxes = Array.from(telegramPane.querySelectorAll('.tg-session-checkbox:not(#tg-selectAllCheckbox)'));
                        const start = allCheckboxes.indexOf(tg_lastCheckedCheckbox);
                        const end = allCheckboxes.indexOf(checkbox);

                        if (start !== -1 && end !== -1) {
                              const lower = Math.min(start, end);
                              const upper = Math.max(start, end);
                              for (let i = lower; i <= upper; i++) {
                                    allCheckboxes[i].checked = checkbox.checked;
                              }
                        }
                  }
                  tg_lastCheckedCheckbox = checkbox;
                  tg_updateSessionCountDisplay();
            }
      });

      document.getElementById('tg-addSessionModal').addEventListener('show.bs.modal', async () => {
            const listEl = document.getElementById('tg-existing-groups-list');
            listEl.innerHTML = `<div class="text-center"><div class="spinner-border spinner-border-sm"></div></div>`;
            try {
                  const r = await fetch('/telegram/api/groups');
                  const groups = await r.json();
                  listEl.innerHTML = groups.map(g => `<div class="d-flex justify-content-between align-items-center p-2 border-bottom"><span>${g.name}</span><button class="btn btn-sm btn-outline-danger tg-delete-group-btn" data-group-id="${g.id}"><i class="bi bi-trash-fill"></i></button></div>`).join('') || '<p class="text-muted text-center">Ch∆∞a c√≥ nh√≥m n√†o.</p>';
            } catch (e) { listEl.innerHTML = `<div class="text-danger text-center">L·ªói t·∫£i nh√≥m.</div>`; }
      });
      document.getElementById('tg-existing-groups-list').addEventListener('click', async e => {
            const deleteBtn = e.target.closest('.tg-delete-group-btn');
            if (deleteBtn) {
                  const groupId = deleteBtn.dataset.groupId;
                  window.confirmDeleteAction(async () => {
                        try {
                              const res = await fetch(`/telegram/api/groups/${groupId}`, { method: 'DELETE' });
                              if (!res.ok) throw new Error("L·ªói server");
                              deleteBtn.closest('.d-flex').remove();
                              await tg_loadGroups();
                        } catch (err) { showToast('L·ªói x√≥a nh√≥m', 'error'); }
                  }, 'B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a nh√≥m n√†y?');
                  return;
            }
      });

      const proxyModalEl = document.getElementById('tg-proxyModal');
      const proxyTextarea = document.getElementById('tg-proxy-list');
      const saveProxyBtn = document.getElementById('tg-save-proxy-btn');
      const proxyEnableCheckbox = document.getElementById('tg-proxy-enabled');

      if (proxyModalEl) {
          proxyModalEl.addEventListener('show.bs.modal', async () => {
              try {
                  const response = await fetch('/telegram/api/proxies');
                  const config = await response.json();
                  proxyTextarea.value = (config.proxies || []).join('\n');
                  proxyEnableCheckbox.checked = config.enabled || false;
              } catch (error) {
                  showToast('L·ªói t·∫£i c·∫•u h√¨nh proxy.', 'error');
              }
          });

          saveProxyBtn.addEventListener('click', async () => {
              try {
                  const payload = {
                      enabled: proxyEnableCheckbox.checked,
                      proxies: proxyTextarea.value
                  };
                  const response = await fetch('/telegram/api/proxies', {
                      method: 'POST',
                      headers: { 'Content-Type': 'application/json' },
                      body: JSON.stringify(payload)
                  });
                  const result = await response.json();
                  if (!response.ok) throw new Error(result.error || 'L·ªói server');
                  showToast(result.message, 'success');
                  bootstrap.Modal.getInstance(proxyModalEl).hide();
              } catch (error) {
                  showToast(`L·ªói l∆∞u proxy: ${error.message}`, 'error');
              }
          });
      }
      // --- START: NEW FUNCTION TO ADD ---
      function tg_makeCellEditable(cell, field, filename) {
          const originalText = cell.textContent.trim();
          const input = document.createElement('input');
          input.type = 'text';
          input.className = 'form-control form-control-sm';
          input.value = originalText;
            input.spellcheck = false;
          
          cell.innerHTML = '';
          cell.appendChild(input);
          input.focus();
          input.select();

          const saveChanges = async () => {
              const newValue = input.value.trim();
              if (newValue === originalText) {
                  cell.textContent = originalText;
                  return;
              }

              const statusCell = cell.closest('tr').cells[6];
              const oldStatusHTML = statusCell.innerHTML;
              statusCell.innerHTML = `<span class="text-info">Updating...</span>`;
              showToast(`Updating ${field}...`, 'info');

              try {
                  const groupId = document.getElementById('tg-group-session-select').value;
                  const response = await fetch(`/telegram/api/update-session-info`, {
                      method: 'POST',
                      headers: { 'Content-Type': 'application/json' },
                      body: JSON.stringify({
                          group_id: groupId,
                          filename: filename,
                          field: field,
                          value: newValue
                      })
                  });

                  const result = await response.json();
                  if (!response.ok) throw new Error(result.error || 'Unknown error');

                  cell.textContent = result.updated_value;
                  if (field === 'username' && result.updated_full_name) {
                      cell.closest('tr').cells[3].textContent = result.updated_full_name;
                  }
                  statusCell.innerHTML = `<span class="text-success">Success!</span>`;
                  showToast(result.message, 'success');

              } catch (error) {
                  cell.textContent = originalText;
                  statusCell.innerHTML = oldStatusHTML;
                  showToast(`Error: ${error.message}`, 'error');
              }
          };

          input.addEventListener('blur', saveChanges);
          input.addEventListener('keydown', (e) => {
              if (e.key === 'Enter') {
                  input.blur();
              } else if (e.key === 'Escape') {
                  cell.textContent = originalText;
                  input.removeEventListener('blur', saveChanges);
                  input.blur();
              }
          });
      }
      // --- END: NEW FUNCTION TO ADD ---

      // --- START: NEW EVENT LISTENER TO ADD ---
      document.getElementById('tg-session-tables-container').addEventListener('dblclick', (e) => {
          const cell = e.target.closest('td');
          if (!cell) return;
          
          const tr = cell.closest('tr');
          const filename = tr.dataset.filename;
          if (!filename) return;

          const cellIndex = cell.cellIndex;
          let field = null;

          if (cellIndex === 3) { // Full Name column
              field = 'full_name';
          } else if (cellIndex === 4) { // Username column
              field = 'username';
          }
          
          if (field) {
              tg_makeCellEditable(cell, field, filename);
          }
      });
      // --- END: NEW EVENT LISTENER TO ADD ---

      // Context menu functionality
      const telegramMenu = document.getElementById('telegram-context-menu');
      if (telegramMenu && telegramPane) {
            telegramPane.addEventListener('contextmenu', function(e) {
                  e.preventDefault();
                  e.stopPropagation();
                  if (typeof hideAllContextMenus === 'function') hideAllContextMenus();
                  telegramMenu.style.display = 'block';
                  telegramMenu.style.left = e.clientX + 'px';
                  telegramMenu.style.top = e.clientY + 'px';
            });

            document.addEventListener('click', () => {
                  if (telegramMenu) telegramMenu.style.display = 'none';
            });

            telegramMenu.addEventListener('contextmenu', e => e.preventDefault());
      }

      console.log('üîç Telegram script fully initialized!');
})();
</script>

{% endblock %}
